<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Ultimate Fix Tool</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 15px;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            font-size: 14px;
        }
        .section {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #111;
        }
        model-viewer {
            width: 100%;
            height: 200px;
            background: #222;
            border-radius: 8px;
            margin: 10px 0;
        }
        .btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            width: 100%;
        }
        .btn:hover { background: #059669; }
        .btn.android { background: #3b82f6; }
        .btn.ios { background: #8b5cf6; }
        .btn.external { background: #f59e0b; }
        .status {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        .success { background: #064e3b; color: #6ee7b7; }
        .error { background: #7f1d1d; color: #fca5a5; }
        .info { background: #1e3a8a; color: #93c5fd; }
        .warning { background: #78350f; color: #fbbf24; }
        .debug-info {
            background: #1f2937;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            margin: 10px 0;
        }
        h3 { margin: 10px 0 5px 0; font-size: 16px; }
        h4 { margin: 8px 0 3px 0; font-size: 14px; color: #93c5fd; }
    </style>
</head>
<body>
    <h2>üîß AR Ultimate Fix Tool</h2>
    
    <div class="debug-info">
        <strong>System Info:</strong><br>
        üì± Device: <span id="device-info"></span><br>
        üåê Protocol: <span id="protocol-info"></span><br>
        üîí HTTPS: <span id="https-info"></span><br>
        üìç URL: <span id="url-info"></span><br>
        üéØ WebXR: <span id="webxr-info"></span>
    </div>

    <!-- Test 1: Known Good External GLB -->
    <div class="section">
        <h3>1. üì¶ External Test Model (Google's Sample)</h3>
        <model-viewer
            id="external-model"
            src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
            alt="Test Astronaut"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            auto-rotate
            loading="lazy">
            <button slot="ar-button" class="btn">üöÄ Test External AR</button>
        </model-viewer>
        <div id="external-status" class="status info">Loading external model...</div>
        <button onclick="manualExternalAR()" class="btn external">üì± Manual External AR</button>
    </div>

    <!-- Test 2: Minimal Local GLB -->
    <div class="section">
        <h3>2. üé≤ Minimal Local Model (1.6KB)</h3>
        <model-viewer
            id="cube-model"
            src="/test-cube.glb"
            ios-src="/test-cube.glb"
            alt="Test Cube"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            auto-rotate
            loading="lazy">
            <button slot="ar-button" class="btn">üé≤ Test Cube AR</button>
        </model-viewer>
        <div id="cube-status" class="status info">Loading cube model...</div>
        <button onclick="manualLocalAR('/test-cube.glb', 'Cube')" class="btn">üì± Manual Cube AR</button>
    </div>

    <!-- Test 3: Your Sofa Model -->
    <div class="section">
        <h3>3. üõãÔ∏è Your Sofa Model (3.4MB)</h3>
        <model-viewer
            id="sofa-model"
            src="/sofa.glb"
            ios-src="/sofa.glb"
            alt="Your Sofa"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            auto-rotate
            loading="lazy">
            <button slot="ar-button" class="btn">üõãÔ∏è Test Sofa AR</button>
        </model-viewer>
        <div id="sofa-status" class="status info">Loading sofa model...</div>
        <button onclick="manualLocalAR('/sofa.glb', 'Sofa')" class="btn">üì± Manual Sofa AR</button>
    </div>

    <!-- Manual AR Tests -->
    <div class="section">
        <h3>4. üéØ Direct AR Launch Tests</h3>
        <h4>Android Scene Viewer:</h4>
        <button onclick="androidAR('/test-cube.glb', 'Cube')" class="btn android">ü§ñ Cube (Android)</button>
        <button onclick="androidAR('/sofa.glb', 'Sofa')" class="btn android">ü§ñ Sofa (Android)</button>
        
        <h4>iOS Quick Look:</h4>
        <button onclick="iosAR('/test-cube.glb', 'Cube')" class="btn ios">üçé Cube (iOS)</button>
        <button onclick="iosAR('/sofa.glb', 'Sofa')" class="btn ios">üçé Sofa (iOS)</button>
        
        <div id="manual-results" class="status info">Ready for manual testing...</div>
    </div>

    <!-- File Diagnostics -->
    <div class="section">
        <h3>5. üîç File Diagnostics</h3>
        <button onclick="testFileHeaders()" class="btn">üî¨ Test GLB Headers</button>
        <button onclick="testFileSizes()" class="btn">üìè Check File Sizes</button>
        <div id="diagnostics-results" class="status info">Click buttons to run diagnostics...</div>
    </div>

    <!-- Network Test -->
    <div class="section">
        <h3>6. üåê Network & CORS Test</h3>
        <button onclick="testNetworkAccess()" class="btn">üåê Test Network Access</button>
        <div id="network-results" class="status info">Click to test network access...</div>
    </div>

    <!-- Solutions -->
    <div class="section">
        <h3>7. üí° Common Solutions</h3>
        <div class="status warning">
            <strong>If AR still doesn't work, try these:</strong><br><br>
            
            <strong>üîß Technical Issues:</strong><br>
            ‚Ä¢ Restart your browser and clear cache<br>
            ‚Ä¢ Try in Chrome browser (best AR support)<br>
            ‚Ä¢ Ensure location services are enabled<br>
            ‚Ä¢ Check camera permissions in browser settings<br><br>
            
            <strong>üì± Mobile Specific:</strong><br>
            ‚Ä¢ Make sure you're on a mobile device (not desktop)<br>
            ‚Ä¢ Update Chrome/Safari to latest version<br>
            ‚Ä¢ For Android: Install Google app if not installed<br>
            ‚Ä¢ For iOS: Use Safari browser for best results<br><br>
            
            <strong>üåç Environment:</strong><br>
            ‚Ä¢ Use in good lighting conditions<br>
            ‚Ä¢ Point camera at flat, textured surface<br>
            ‚Ä¢ Avoid reflective surfaces (glass, mirrors)<br>
            ‚Ä¢ Ensure adequate space around you
        </div>
    </div>

    <script>
        // Device detection
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        const hasWebXR = 'xr' in navigator;

        // Update system info
        document.getElementById('device-info').textContent = 
            isAndroid ? 'Android' : isIOS ? 'iOS' : 'Desktop' + (isMobile ? ' (Mobile)' : '');
        document.getElementById('protocol-info').textContent = window.location.protocol;
        document.getElementById('https-info').textContent = window.isSecureContext ? '‚úÖ Yes' : '‚ùå No';
        document.getElementById('url-info').textContent = window.location.href;
        document.getElementById('webxr-info').textContent = hasWebXR ? '‚úÖ Available' : '‚ùå Not Available';

        // Model loading handlers
        function setupModelHandlers() {
            const models = [
                { id: 'external-model', status: 'external-status', name: 'External' },
                { id: 'cube-model', status: 'cube-status', name: 'Cube' },
                { id: 'sofa-model', status: 'sofa-status', name: 'Sofa' }
            ];

            models.forEach(({ id, status, name }) => {
                const model = document.getElementById(id);
                const statusDiv = document.getElementById(status);

                model.addEventListener('load', () => {
                    statusDiv.textContent = `‚úÖ ${name} loaded! AR should work.`;
                    statusDiv.className = 'status success';
                });

                model.addEventListener('error', (event) => {
                    statusDiv.textContent = `‚ùå ${name} failed: ${event.detail || 'Unknown error'}`;
                    statusDiv.className = 'status error';
                });

                model.addEventListener('ar-status', (event) => {
                    statusDiv.innerHTML += `<br>üì± AR: ${event.detail.status}`;
                });
            });
        }

        // Manual AR launch functions
        function androidAR(modelPath, name) {
            const results = document.getElementById('manual-results');
            
            if (!isAndroid) {
                results.textContent = '‚ùå Android AR requires Android device';
                results.className = 'status error';
                return;
            }

            const modelUrl = `${window.location.origin}${modelPath}`;
            const arUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(modelUrl)}&mode=ar_preferred#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(window.location.href)};end;`;
            
            results.innerHTML = `üöÄ Launching ${name} on Android...<br>URL: ${modelUrl}`;
            results.className = 'status info';
            
            console.log('Android AR URL:', arUrl);
            window.location.href = arUrl;
        }

        function iosAR(modelPath, name) {
            const results = document.getElementById('manual-results');
            
            if (!isIOS) {
                results.textContent = '‚ùå iOS AR requires iOS device';
                results.className = 'status error';
                return;
            }

            const modelUrl = `${window.location.origin}${modelPath}`;
            results.innerHTML = `üçé Launching ${name} on iOS...<br>URL: ${modelUrl}`;
            results.className = 'status info';
            
            const link = document.createElement('a');
            link.href = modelUrl;
            link.rel = 'ar';
            link.download = `${name}.glb`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => {
                results.innerHTML += '<br>‚úÖ iOS Quick Look launched!';
                results.className = 'status success';
            }, 1000);
        }

        function manualLocalAR(modelPath, name) {
            if (isAndroid) {
                androidAR(modelPath, name);
            } else if (isIOS) {
                iosAR(modelPath, name);
            } else {
                const results = document.getElementById('manual-results');
                results.textContent = '‚ùå AR requires mobile device (Android or iOS)';
                results.className = 'status error';
            }
        }

        function manualExternalAR() {
            if (isAndroid) {
                const results = document.getElementById('manual-results');
                const arUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent('https://modelviewer.dev/shared-assets/models/Astronaut.glb')}&mode=ar_preferred#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(window.location.href)};end;`;
                results.innerHTML = 'üöÄ Testing external model on Android...';
                results.className = 'status info';
                window.location.href = arUrl;
            } else if (isIOS) {
                const results = document.getElementById('manual-results');
                results.innerHTML = 'üçé Testing external model on iOS...';
                results.className = 'status info';
                const link = document.createElement('a');
                link.href = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
                link.rel = 'ar';
                link.download = 'Astronaut.glb';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                const results = document.getElementById('manual-results');
                results.textContent = '‚ùå AR requires mobile device';
                results.className = 'status error';
            }
        }

        // File diagnostics
        async function testFileHeaders() {
            const results = document.getElementById('diagnostics-results');
            const files = ['/test-cube.glb', '/sofa.glb'];
            
            results.innerHTML = 'Testing GLB file headers...<br>';
            
            for (const file of files) {
                try {
                    const response = await fetch(file, { 
                        method: 'GET',
                        headers: { 'Range': 'bytes=0-11' }
                    });
                    
                    if (response.ok) {
                        const buffer = await response.arrayBuffer();
                        const view = new DataView(buffer);
                        const magic = view.getUint32(0, true);
                        const version = view.getUint32(4, true);
                        
                        if (magic === 0x46546C67) {
                            results.innerHTML += `‚úÖ ${file} - Valid GLB v${version}<br>`;
                        } else {
                            results.innerHTML += `‚ùå ${file} - Invalid GLB header<br>`;
                        }
                    }
                } catch (error) {
                    results.innerHTML += `‚ùå ${file} - Header test failed: ${error.message}<br>`;
                }
            }
            results.className = 'status info';
        }

        async function testFileSizes() {
            const results = document.getElementById('diagnostics-results');
            const files = ['/test-cube.glb', '/sofa.glb', '/old_wooden_chair.glb'];
            
            results.innerHTML = 'Checking file sizes...<br>';
            
            for (const file of files) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    const size = response.headers.get('content-length');
                    const sizeMB = (parseInt(size) / 1024 / 1024).toFixed(2);
                    
                    if (response.ok) {
                        const sizeStatus = sizeMB > 10 ? '‚ö†Ô∏è' : '‚úÖ';
                        results.innerHTML += `${sizeStatus} ${file} - ${sizeMB}MB<br>`;
                    }
                } catch (error) {
                    results.innerHTML += `‚ùå ${file} - Size check failed<br>`;
                }
            }
            results.className = 'status info';
        }

        async function testNetworkAccess() {
            const results = document.getElementById('network-results');
            results.innerHTML = 'Testing network access and CORS...<br>';
            
            try {
                // Test local file access
                const localTest = await fetch('/sofa.glb', { method: 'HEAD' });
                results.innerHTML += `‚úÖ Local file access: ${localTest.status}<br>`;
                
                // Test external access
                const externalTest = await fetch('https://modelviewer.dev/shared-assets/models/Astronaut.glb', { method: 'HEAD' });
                results.innerHTML += `‚úÖ External file access: ${externalTest.status}<br>`;
                
                // Test CORS headers
                const corsHeaders = localTest.headers.get('access-control-allow-origin');
                results.innerHTML += `‚úÖ CORS headers: ${corsHeaders || 'Not set'}<br>`;
                
                results.className = 'status success';
            } catch (error) {
                results.innerHTML += `‚ùå Network test failed: ${error.message}<br>`;
                results.className = 'status error';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupModelHandlers();
            
            // Log debug info
            console.log('üîç AR Debug Session Started');
            console.log('Device:', { isAndroid, isIOS, isMobile });
            console.log('WebXR:', hasWebXR);
            console.log('Secure Context:', window.isSecureContext);
            console.log('Available Models:', ['/test-cube.glb', '/sofa.glb']);
        });
    </script>
</body>
</html>
