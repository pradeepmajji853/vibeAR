<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLB File Diagnostics</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
        }
        .test-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 10px;
            background: #111;
        }
        model-viewer {
            width: 100%;
            height: 300px;
            background: #222;
            border-radius: 10px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .success { background: #1a5a1a; color: #4ade80; }
        .error { background: #5a1a1a; color: #f87171; }
        .warning { background: #5a4a1a; color: #fbbf24; }
        .info { background: #1a3a5a; color: #60a5fa; }
        .ar-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            border-radius: 20px;
            cursor: pointer;
            margin: 5px;
        }
        .ar-button:hover {
            background: #059669;
        }
        .file-info {
            background: #1f2937;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç GLB File Diagnostics & AR Fix</h1>
    
    <div class="file-info">
        <strong>Device Info:</strong><br>
        üì± User Agent: <span id="userAgent"></span><br>
        üåê Protocol: <span id="protocol"></span><br>
        üîí Secure Context: <span id="secure"></span><br>
        üìç Current URL: <span id="currentUrl"></span>
    </div>

    <div class="test-container">
        <h2>1. File Accessibility Test</h2>
        <div id="file-test" class="status info">Testing file access...</div>
        <button onclick="testFileAccess()" class="ar-button">üîÑ Re-test Files</button>
    </div>

    <div class="test-container">
        <h2>2. GLB File Validation</h2>
        <div id="validation-test" class="status info">Validating GLB files...</div>
    </div>

    <div class="test-container">
        <h2>3. Model Viewer Test - Sofa (3.4MB)</h2>
        <model-viewer
            id="sofa-viewer"
            src="/sofa.glb"
            alt="Modern Sofa"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            auto-rotate
            environment-image="neutral"
            loading="lazy"
            ios-src="/sofa.glb">
            <button slot="ar-button" class="ar-button">üì± View Sofa in AR</button>
        </model-viewer>
        <div id="sofa-status" class="status info">Loading sofa model...</div>
    </div>

    <div class="test-container">
        <h2>4. Model Viewer Test - Chair (Smaller)</h2>
        <model-viewer
            id="chair-viewer"
            src="/old_wooden_chair.glb"
            alt="Wooden Chair"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            auto-rotate
            environment-image="neutral"
            loading="lazy"
            ios-src="/old_wooden_chair.glb">
            <button slot="ar-button" class="ar-button">üì± View Chair in AR</button>
        </model-viewer>
        <div id="chair-status" class="status info">Loading chair model...</div>
    </div>

    <div class="test-container">
        <h2>5. Manual AR Launch Tests</h2>
        <p>Try these manual AR launches if model-viewer AR button doesn't work:</p>
        
        <div style="margin: 15px 0;">
            <strong>Android Scene Viewer:</strong><br>
            <button onclick="launchAndroidAR('/sofa.glb', 'Sofa')" class="ar-button">ü§ñ Sofa AR (Android)</button>
            <button onclick="launchAndroidAR('/old_wooden_chair.glb', 'Chair')" class="ar-button">ü§ñ Chair AR (Android)</button>
        </div>
        
        <div style="margin: 15px 0;">
            <strong>iOS Quick Look:</strong><br>
            <button onclick="launchIOSAR('/sofa.glb', 'Sofa')" class="ar-button">üçé Sofa AR (iOS)</button>
            <button onclick="launchIOSAR('/old_wooden_chair.glb', 'Chair')" class="ar-button">üçé Chair AR (iOS)</button>
        </div>
        
        <div id="manual-status" class="status info">Ready to test manual AR launches...</div>
    </div>

    <div class="test-container">
        <h2>6. GLB File Optimization</h2>
        <div class="status warning">
            <strong>‚ö†Ô∏è Common Issues & Solutions:</strong><br>
            ‚Ä¢ <strong>File too large:</strong> The 109MB table model is too big for mobile AR<br>
            ‚Ä¢ <strong>Invalid GLB:</strong> Some GLB files may have compatibility issues<br>
            ‚Ä¢ <strong>CORS issues:</strong> Self-signed SSL certificates can cause problems<br>
            ‚Ä¢ <strong>Model complexity:</strong> Very detailed models may not load in AR<br><br>
            
            <strong>‚úÖ Recommended:</strong><br>
            ‚Ä¢ Use models under 10MB for AR<br>
            ‚Ä¢ Test with the sofa (3.4MB) or chair models first<br>
            ‚Ä¢ Ensure GLB files are optimized for mobile<br>
            ‚Ä¢ Use proper GLB compression
        </div>
        
        <button onclick="testOptimizedModel()" class="ar-button">üéØ Test with External GLB</button>
        <div id="optimization-status" class="status info">Click button to test with a known-good GLB model</div>
    </div>

    <script>
        // Device detection and info
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);

        // Populate device info
        document.getElementById('userAgent').textContent = navigator.userAgent.substring(0, 80) + '...';
        document.getElementById('protocol').textContent = window.location.protocol;
        document.getElementById('secure').textContent = window.isSecureContext ? '‚úÖ Yes' : '‚ùå No';
        document.getElementById('currentUrl').textContent = window.location.href;

        // File accessibility test
        async function testFileAccess() {
            const status = document.getElementById('file-test');
            const files = ['/sofa.glb', '/old_wooden_chair.glb', '/wooden_bed.glb'];
            
            status.innerHTML = 'Testing file accessibility...<br>';
            
            for (const file of files) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    const size = response.headers.get('content-length');
                    const type = response.headers.get('content-type');
                    
                    if (response.ok) {
                        status.innerHTML += `‚úÖ ${file} - OK (${Math.round(size/1024/1024*100)/100}MB, ${type})<br>`;
                        status.className = 'status success';
                    } else {
                        status.innerHTML += `‚ùå ${file} - Error ${response.status}<br>`;
                        status.className = 'status error';
                    }
                } catch (error) {
                    status.innerHTML += `‚ùå ${file} - Network error: ${error.message}<br>`;
                    status.className = 'status error';
                }
            }
        }

        // GLB validation test
        async function validateGLB() {
            const status = document.getElementById('validation-test');
            const files = ['/sofa.glb', '/old_wooden_chair.glb'];
            
            status.innerHTML = 'Validating GLB file headers...<br>';
            
            for (const file of files) {
                try {
                    const response = await fetch(file, { 
                        method: 'GET',
                        headers: { 'Range': 'bytes=0-11' } // Get first 12 bytes for GLB header
                    });
                    
                    if (response.ok) {
                        const buffer = await response.arrayBuffer();
                        const view = new DataView(buffer);
                        
                        // Check GLB magic number (should be 0x46546C67 = "glTF")
                        const magic = view.getUint32(0, true);
                        const version = view.getUint32(4, true);
                        const length = view.getUint32(8, true);
                        
                        if (magic === 0x46546C67) {
                            status.innerHTML += `‚úÖ ${file} - Valid GLB (v${version}, ${length} bytes)<br>`;
                            status.className = 'status success';
                        } else {
                            status.innerHTML += `‚ùå ${file} - Invalid GLB magic number<br>`;
                            status.className = 'status error';
                        }
                    }
                } catch (error) {
                    status.innerHTML += `‚ùå ${file} - Validation error: ${error.message}<br>`;
                    status.className = 'status error';
                }
            }
        }

        // Model viewer event handlers
        function setupModelHandlers() {
            const models = [
                { element: 'sofa-viewer', status: 'sofa-status', name: 'Sofa' },
                { element: 'chair-viewer', status: 'chair-status', name: 'Chair' }
            ];

            models.forEach(({ element, status, name }) => {
                const model = document.getElementById(element);
                const statusDiv = document.getElementById(status);

                model.addEventListener('load', () => {
                    statusDiv.innerHTML = `‚úÖ ${name} model loaded successfully! AR should work now.`;
                    statusDiv.className = 'status success';
                });

                model.addEventListener('error', (event) => {
                    statusDiv.innerHTML = `‚ùå ${name} model failed to load: ${event.detail || 'Unknown error'}`;
                    statusDiv.className = 'status error';
                    
                    // Try to provide more specific error info
                    setTimeout(() => {
                        statusDiv.innerHTML += '<br>üí° This could be due to: file corruption, network issues, or GLB format problems';
                    }, 1000);
                });

                model.addEventListener('ar-status', (event) => {
                    statusDiv.innerHTML += `<br>üì± AR Status: ${event.detail.status}`;
                });
            });
        }

        // Manual AR launches
        function launchAndroidAR(modelFile, name) {
            const status = document.getElementById('manual-status');
            const modelUrl = `${window.location.origin}${modelFile}`;
            
            if (isAndroid) {
                const arUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(modelUrl)}&mode=ar_preferred#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(window.location.href)};end;`;
                
                status.innerHTML = `üöÄ Launching ${name} in Android AR...<br>URL: ${modelUrl}`;
                status.className = 'status info';
                
                window.location.href = arUrl;
                
                setTimeout(() => {
                    status.innerHTML += '<br>üí° If AR didn\'t launch, make sure Google app is installed and updated';
                }, 2000);
            } else {
                status.innerHTML = `‚ùå Android AR requires an Android device. Current device: ${isIOS ? 'iOS' : 'Desktop'}`;
                status.className = 'status error';
            }
        }

        function launchIOSAR(modelFile, name) {
            const status = document.getElementById('manual-status');
            const modelUrl = `${window.location.origin}${modelFile}`;
            
            if (isIOS) {
                status.innerHTML = `üçé Launching ${name} in iOS AR Quick Look...`;
                status.className = 'status info';
                
                const link = document.createElement('a');
                link.href = modelUrl;
                link.rel = 'ar';
                link.download = `${name}.glb`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    status.innerHTML += '<br>‚úÖ iOS AR Quick Look should have launched!';
                    status.className = 'status success';
                }, 1000);
            } else {
                status.innerHTML = `‚ùå iOS AR requires an iOS device. Current device: ${isAndroid ? 'Android' : 'Desktop'}`;
                status.className = 'status error';
            }
        }

        // Test with a known-good external GLB model
        function testOptimizedModel() {
            const status = document.getElementById('optimization-status');
            const container = document.querySelector('#optimization-status').parentElement;
            
            // Create a new model-viewer with a known-good GLB from the internet
            const testModel = document.createElement('model-viewer');
            testModel.src = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
            testModel.alt = 'Test Astronaut';
            testModel.setAttribute('ar', '');
            testModel.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
            testModel.setAttribute('camera-controls', '');
            testModel.setAttribute('auto-rotate', '');
            testModel.style.width = '100%';
            testModel.style.height = '250px';
            testModel.style.marginTop = '15px';
            
            // Add AR button
            const arButton = document.createElement('button');
            arButton.slot = 'ar-button';
            arButton.className = 'ar-button';
            arButton.textContent = 'üöÄ Test External GLB in AR';
            testModel.appendChild(arButton);
            
            testModel.addEventListener('load', () => {
                status.innerHTML = '‚úÖ External GLB loaded successfully! This proves your AR setup works.<br>üí° The issue is likely with your local GLB files.';
                status.className = 'status success';
            });
            
            testModel.addEventListener('error', () => {
                status.innerHTML = '‚ùå Even external GLB failed to load. This suggests a deeper AR or network issue.';
                status.className = 'status error';
            });
            
            container.appendChild(testModel);
            status.innerHTML = 'üîÑ Testing with external GLB model...';
            status.className = 'status info';
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            testFileAccess();
            validateGLB();
            setupModelHandlers();
        });
    </script>
</body>
</html>
