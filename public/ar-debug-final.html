<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Debug Final - Could Not Load Object Fix</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        body { 
            margin: 0; padding: 20px; font-family: Arial, sans-serif; 
            background: #000; color: white; line-height: 1.6; 
        }
        .container { max-width: 800px; margin: 0 auto; }
        .section { 
            margin: 30px 0; padding: 20px; background: #111; 
            border-radius: 15px; border: 1px solid #333; 
        }
        model-viewer { 
            width: 100%; height: 300px; background: #222; 
            border-radius: 10px; margin: 15px 0; 
        }
        .btn { 
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white; border: none; padding: 15px 25px; 
            font-size: 16px; border-radius: 25px; cursor: pointer; 
            margin: 10px 5px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        .android { background: linear-gradient(45deg, #4285f4, #34a853); }
        .ios { background: linear-gradient(45deg, #007aff, #5856d6); }
        .status { 
            padding: 10px; margin: 10px 0; border-radius: 5px; 
            font-size: 14px; min-height: 20px;
        }
        .success { background: #1b5e20; border: 1px solid #4caf50; }
        .error { background: #b71c1c; border: 1px solid #f44336; }
        .info { background: #1a237e; border: 1px solid #3f51b5; }
        .debug { 
            background: #212121; padding: 15px; border-radius: 8px; 
            margin: 15px 0; border-left: 4px solid #ff9800; 
            font-family: monospace; font-size: 12px;
        }
        .critical { 
            background: #3e2723; border: 2px solid #ff6f00; 
            padding: 20px; border-radius: 10px; margin: 20px 0;
        }
        .fix-item {
            background: #0d47a1; padding: 15px; margin: 10px 0;
            border-radius: 8px; border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß AR Debug Final - "Could Not Load Object" Fix</h1>
        
        <div class="critical">
            <h2>üö® Common "Could Not Load Object" Fixes</h2>
            <div class="fix-item">
                <strong>1. HTTPS Required:</strong> AR only works on HTTPS. ‚úÖ Your dev server uses HTTPS.
            </div>
            <div class="fix-item">
                <strong>2. Mobile Device:</strong> AR requires actual mobile device (not desktop/simulator).
            </div>
            <div class="fix-item">
                <strong>3. File Size:</strong> Large models (>50MB) may timeout. Try smaller models first.
            </div>
            <div class="fix-item">
                <strong>4. MIME Type:</strong> Server must serve .glb as 'model/gltf-binary'.
            </div>
        </div>

        <!-- Device Info -->
        <div class="section">
            <h2>üì± Device Information</h2>
            <div id="device-info" class="debug">Detecting device...</div>
        </div>

        <!-- File Test -->
        <div class="section">
            <h2>üìÅ GLB File Access Test</h2>
            <div id="file-test" class="status info">Testing file access...</div>
            <button onclick="testFileAccess()" class="btn">üîÑ Re-test File Access</button>
        </div>

        <!-- Minimal AR Test -->
        <div class="section">
            <h2>üéØ Minimal AR Test (Sofa - 3.4MB)</h2>
            <model-viewer
                id="minimal-ar"
                src="/sofa.glb"
                ios-src="/sofa.glb"
                alt="Sofa AR Test"
                ar
                ar-modes="webxr scene-viewer quick-look"
                camera-controls
                auto-rotate
                loading="lazy"
                interaction-prompt="none">
                <button slot="ar-button" class="btn">üì± Test AR Now</button>
            </model-viewer>
            <div id="minimal-status" class="status info">Loading minimal model...</div>
        </div>

        <!-- Direct AR Launch -->
        <div class="section">
            <h2>üöÄ Direct AR Launch (Bypass Model Viewer)</h2>
            <p>These buttons directly launch AR without using model-viewer:</p>
            
            <h3>Android Scene Viewer:</h3>
            <button onclick="directAndroidAR('/sofa.glb')" class="btn android">ü§ñ Sofa AR (Android)</button>
            
            <h3>iOS Quick Look:</h3>
            <button onclick="directIOSAR('/sofa.glb')" class="btn ios">üçé Sofa AR (iOS)</button>
            
            <div id="direct-status" class="status info">Ready to test direct AR...</div>
        </div>

        <!-- Advanced Debugging -->
        <div class="section">
            <h2>üîç Advanced Debugging</h2>
            <button onclick="debugGLB('/sofa.glb')" class="btn">üî¨ Debug GLB File</button>
            <button onclick="testARSupport()" class="btn">üìä Test AR Support</button>
            <div id="debug-output" class="debug">Debug output will appear here...</div>
        </div>

        <!-- Error Patterns -->
        <div class="section">
            <h2>‚ö†Ô∏è Common Error Patterns & Fixes</h2>
            <div class="fix-item">
                <strong>"Could not load object"</strong> ‚Üí File not found or wrong MIME type
            </div>
            <div class="fix-item">
                <strong>"AR not supported"</strong> ‚Üí Need real mobile device with AR capability
            </div>
            <div class="fix-item">
                <strong>"Network error"</strong> ‚Üí HTTPS certificate not trusted on mobile
            </div>
            <div class="fix-item">
                <strong>"Timeout"</strong> ‚Üí File too large (try smaller models first)
            </div>
        </div>
    </div>

    <script>
        // Device detection
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        const isChrome = /Chrome/i.test(navigator.userAgent);
        const isSafari = /Safari/i.test(navigator.userAgent) && !isChrome;

        // Update device info
        document.addEventListener('DOMContentLoaded', function() {
            const deviceInfo = document.getElementById('device-info');
            deviceInfo.innerHTML = `
                <strong>Platform:</strong> ${isAndroid ? 'Android' : isIOS ? 'iOS' : 'Desktop'}<br>
                <strong>Browser:</strong> ${isChrome ? 'Chrome' : isSafari ? 'Safari' : 'Other'}<br>
                <strong>Mobile:</strong> ${isMobile ? 'Yes' : 'No'}<br>
                <strong>Protocol:</strong> ${window.location.protocol}<br>
                <strong>AR Supported:</strong> ${(isAndroid || isIOS) ? 'Likely Yes' : 'No (need mobile)'}
            `;

            // Test file access immediately
            testFileAccess();
            
            // Setup model event listeners
            setupModelListeners();
        });

        // Test file accessibility
        async function testFileAccess() {
            const fileTest = document.getElementById('file-test');
            fileTest.innerHTML = 'Testing file access...';
            
            try {
                const response = await fetch('/sofa.glb');
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    const contentLength = response.headers.get('content-length');
                    const size = contentLength ? (parseInt(contentLength) / (1024 * 1024)).toFixed(2) + ' MB' : 'Unknown';
                    
                    fileTest.innerHTML = `
                        ‚úÖ <strong>File accessible!</strong><br>
                        ‚Ä¢ Size: ${size}<br>
                        ‚Ä¢ MIME Type: ${contentType || 'Not specified'}<br>
                        ‚Ä¢ Status: ${response.status} ${response.statusText}
                    `;
                    fileTest.className = 'status success';
                } else {
                    fileTest.innerHTML = `‚ùå File access failed: ${response.status} ${response.statusText}`;
                    fileTest.className = 'status error';
                }
            } catch (error) {
                fileTest.innerHTML = `‚ùå File access error: ${error.message}`;
                fileTest.className = 'status error';
            }
        }

        // Setup model event listeners
        function setupModelListeners() {
            const model = document.getElementById('minimal-ar');
            const status = document.getElementById('minimal-status');

            model.addEventListener('load', () => {
                status.innerHTML = '‚úÖ <strong>Model loaded successfully!</strong><br>AR button should work now.';
                status.className = 'status success';
            });

            model.addEventListener('error', (event) => {
                const errorMsg = event.detail || 'Unknown error';
                status.innerHTML = `‚ùå <strong>Model failed to load:</strong><br>${errorMsg}`;
                status.className = 'status error';
            });

            model.addEventListener('ar-status', (event) => {
                status.innerHTML += `<br>üì± AR Status: ${event.detail.status}`;
            });
        }

        // Direct Android AR (bypass model-viewer)
        function directAndroidAR(modelPath) {
            const directStatus = document.getElementById('direct-status');
            
            if (!isAndroid) {
                directStatus.innerHTML = '‚ùå Android AR only works on Android devices';
                directStatus.className = 'status error';
                return;
            }

            const fullUrl = `${window.location.origin}${modelPath}`;
            const arUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(fullUrl)}&mode=ar_preferred#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(window.location.href)};end;`;
            
            directStatus.innerHTML = `üöÄ Launching Android AR for: ${modelPath}`;
            directStatus.className = 'status info';
            
            try {
                window.location.href = arUrl;
            } catch (error) {
                directStatus.innerHTML = `‚ùå Android AR launch failed: ${error.message}`;
                directStatus.className = 'status error';
            }
        }

        // Direct iOS AR (bypass model-viewer)
        function directIOSAR(modelPath) {
            const directStatus = document.getElementById('direct-status');
            
            if (!isIOS) {
                directStatus.innerHTML = '‚ùå iOS AR only works on iOS devices';
                directStatus.className = 'status error';
                return;
            }

            const fullUrl = `${window.location.origin}${modelPath}`;
            const link = document.createElement('a');
            link.href = fullUrl;
            link.rel = 'ar';
            link.download = 'sofa.glb';
            
            directStatus.innerHTML = `üöÄ Launching iOS AR for: ${modelPath}`;
            directStatus.className = 'status info';
            
            try {
                link.click();
            } catch (error) {
                directStatus.innerHTML = `‚ùå iOS AR launch failed: ${error.message}`;
                directStatus.className = 'status error';
            }
        }

        // Debug GLB file
        async function debugGLB(modelPath) {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.innerHTML = 'Debugging GLB file...';
            
            try {
                const response = await fetch(modelPath);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const bytes = new Uint8Array(arrayBuffer);
                
                // Check GLB magic number (first 4 bytes should be "glTF")
                const magic = String.fromCharCode(bytes[0], bytes[1], bytes[2], bytes[3]);
                const version = new DataView(arrayBuffer).getUint32(4, true);
                const length = new DataView(arrayBuffer).getUint32(8, true);
                
                debugOutput.innerHTML = `
                    <strong>GLB File Analysis:</strong><br>
                    ‚Ä¢ File Size: ${(arrayBuffer.byteLength / (1024 * 1024)).toFixed(2)} MB<br>
                    ‚Ä¢ Magic Number: "${magic}" ${magic === 'glTF' ? '‚úÖ' : '‚ùå'}<br>
                    ‚Ä¢ Version: ${version} ${version === 2 ? '‚úÖ' : '‚ùå'}<br>
                    ‚Ä¢ Declared Length: ${(length / (1024 * 1024)).toFixed(2)} MB<br>
                    ‚Ä¢ MIME Type: ${response.headers.get('content-type') || 'Not specified'}<br>
                    ‚Ä¢ First 16 bytes: ${Array.from(bytes.slice(0, 16)).map(b => b.toString(16).padStart(2, '0')).join(' ')}
                `;
                
            } catch (error) {
                debugOutput.innerHTML = `‚ùå GLB Debug Error: ${error.message}`;
            }
        }

        // Test AR support
        function testARSupport() {
            const debugOutput = document.getElementById('debug-output');
            
            const tests = {
                'WebXR Support': 'xr' in navigator,
                'Mobile Device': isMobile,
                'HTTPS': window.location.protocol === 'https:',
                'Model Viewer Available': !!customElements.get('model-viewer'),
                'Camera API': 'mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices,
                'iOS Safari': isIOS && isSafari,
                'Android Chrome': isAndroid && isChrome
            };
            
            let output = '<strong>AR Support Analysis:</strong><br>';
            for (const [test, result] of Object.entries(tests)) {
                output += `‚Ä¢ ${test}: ${result ? '‚úÖ Yes' : '‚ùå No'}<br>`;
            }
            
            debugOutput.innerHTML = output;
        }
    </script>
</body>
</html>
